<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Munich Safe Ways</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            font-family: "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: #0f172a;
            --fast-color: #6b7280;
            --safe-color: #0b4b7c;
            --scenic-color: #0f6d2c;
            --fast-shadow: rgba(107, 114, 128, 0.24);
            --safe-shadow: rgba(11, 75, 124, 0.24);
            --scenic-shadow: rgba(15, 109, 44, 0.20);
            --accent-walk: #d7a43b;
            --accent-bike: #d7a43b;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1d3557 40%, #457b9d 100%);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .controls {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 1000;
            width: min(360px, calc(100% - 48px));
            padding: 22px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.92);
            box-shadow: 0 30px 45px rgba(15, 23, 42, 0.35);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            gap: 14px;
            transition: box-shadow 0.25s ease, border-color 0.25s ease;
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .transport-toggle {
            position: relative;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            align-items: center;
            background: linear-gradient(135deg, #0f172a, #111827);
            border-radius: 999px;
            padding: 4px;
            gap: 6px;
        }

        .transport-toggle button {
            border: none;
            background: transparent;
            border-radius: 999px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 600;
            color: #e2e8f0;
            cursor: pointer;
            transition: color 0.2s ease;
            position: relative;
            z-index: 1;
        }

        .transport-toggle .toggle-slider {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            width: calc(50% - 6px);
            border-radius: 999px;
            background: #0b4b7c;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
            transition: transform 0.25s ease, background 0.25s ease, box-shadow 0.25s ease;
        }

        .transport-toggle.walk .toggle-slider {
            transform: translateX(0) scale(1.02);
            background: var(--accent-walk);
            box-shadow: 0 10px 22px rgba(15, 109, 44, 0.22);
        }

        .transport-toggle.bike .toggle-slider {
            transform: translateX(100%) scale(1.02);
            background: var(--accent-bike);
            box-shadow: 0 10px 22px rgba(11, 75, 124, 0.22);
        }

        .transport-toggle.walk button[data-transport="walk"],
        .transport-toggle.bike button[data-transport="bike"] {
            color: #0f172a;
            font-weight: 700;
        }

        body.bike-mode {
            background: linear-gradient(135deg, #0a1f33 0%, #0c3b6a 45%, #0f6d2c 100%);
        }

        body.walk-mode .controls {
            box-shadow: 0 30px 45px rgba(15, 109, 44, 0.22);
            border-color: rgba(15, 109, 44, 0.24);
        }

        body.bike-mode .controls {
            box-shadow: 0 30px 45px rgba(11, 75, 124, 0.24);
            border-color: rgba(11, 75, 124, 0.2);
        }

        body.bike-mode .stats-card {
            border-color: rgba(11, 75, 124, 0.2);
            box-shadow: 0 14px 24px rgba(11, 75, 124, 0.12);
        }

        body.walk-mode .stats-card {
            border-color: rgba(15, 109, 44, 0.2);
            box-shadow: 0 14px 24px rgba(15, 109, 44, 0.12);
        }

        .controls h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #0f172a;
        }

        .controls p {
            margin: 0;
            font-size: 13px;
            color: #475569;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mode-card {
            border: 1px solid rgba(15, 23, 42, 0.14);
            border-radius: 16px;
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
        }

        .mode-card:hover {
            border-color: rgba(15, 23, 42, 0.4);
            box-shadow: 0 16px 24px rgba(15, 23, 42, 0.12);
            transform: translateY(-1px);
        }

        .mode-card.active {
            border-color: #0f6d2c;
            box-shadow: 0 18px 28px rgba(15, 109, 44, 0.12);
        }

        .mode-card.active[data-mode="fast"] {
            border-color: var(--fast-color);
            box-shadow: 0 22px 30px var(--fast-shadow);
        }

        .mode-card.active[data-mode="safe"] {
            border-color: var(--safe-color);
            box-shadow: 0 22px 30px var(--safe-shadow);
        }

        .mode-card.active[data-mode="scenic"] {
            border-color: var(--scenic-color);
            box-shadow: 0 22px 30px var(--scenic-shadow);
        }

        .mode-chip {
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            background: #f1f5f9;
            color: #0f172a;
            cursor: pointer;
        }

        .mode-card.active .mode-chip {
            background: #0f6d2c;
            color: #fff;
        }

        .mode-card.active[data-mode="fast"] .mode-chip {
            background: var(--fast-color);
        }

        .mode-card.active[data-mode="safe"] .mode-chip {
            background: var(--safe-color);
        }

        .mode-card.active[data-mode="scenic"] .mode-chip {
            background: var(--scenic-color);
        }

        .mode-card p {
            font-size: 12px;
            color: #475569;
            line-height: 1.45;
        }

        .hint {
            font-size: 12px;
            color: #334155;
            border-top: 1px solid rgba(15, 23, 42, 0.08);
            padding-top: 10px;
            line-height: 1.4;
        }

        .stats-card {
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 18px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(248, 250, 252, 0.9);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 14px 18px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #94a3b8;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #0f172a;
        }

        .stat-note {
            font-size: 11px;
            color: #64748b;
        }

        .comparison-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .comparison-pill {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #e2e8f0;
            color: #0f172a;
        }

        .comparison-pill.good {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .comparison-pill.bad {
            background: rgba(248, 113, 113, 0.16);
            color: #b91c1c;
        }

        .comparison-pill.neutral {
            background: rgba(148, 163, 184, 0.2);
            color: #475569;
        }

        @media (max-width: 600px) {
            .controls {
                top: auto;
                bottom: 16px;
                left: 16px;
                right: 16px;
                width: auto;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="controls">
        <div class="transport-toggle walk" id="transport-toggle">
            <div class="toggle-slider"></div>
            <button type="button" data-transport="walk" aria-label="Walking mode">Walk</button>
            <button type="button" data-transport="bike" aria-label="Biking mode">Bike</button>
        </div>
        <div id="mode-buttons" class="mode-buttons"></div>
        <div class="hint">Click once for start, once for end. A third click resets.</div>
        <div class="stats-card" id="stats-card">
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-label">Distance</div>
                    <div class="stat-value" id="stat-distance">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ETA</div>
                    <div class="stat-value" id="stat-duration">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label" id="stat-steps-label">Steps</div>
                    <div class="stat-value" id="stat-steps">--</div>
                    <div class="stat-note" id="stat-kcal">≈ -- kcal burned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Saved CO2</div>
                    <div class="stat-value" id="stat-co2">--</div>
                    <div class="stat-note" id="stat-co2-eq">≈ tangible savings</div>
                </div>
            </div>
            <div class="comparison-list" id="comparison-list">
                <span class="comparison-pill neutral">Pick two points to compare modes</span>
            </div>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const backendUrl = "http://localhost:8000";
        const STEP_LENGTH_M = 0.78; // average adult step length in meters
        const KCAL_PER_STEP = 0.05; // approximate kcal burned per step for a casual walk
        const BIKE_KCAL_PER_KM = 24; // moderate cycling kcal per km
        const BIKE_WH_PER_KM = 18; // rough watt-hour effort per km
        const CAR_CO2_KG_PER_KM = 0.192; // average passenger car emissions per km
        const PHONE_CHARGE_CO2_KG = 0.2; // approx CO2 per full smartphone charge, rounded for simpler integers
        const MODE_OPTIONS_WALK = [
            {
                id: "fast",
                label: "Direct",
                description: "Cuts through traffic, shrugs at scenery and even rewards darker shortcuts.",
            },
            {
                id: "safe",
                label: "Night Safe",
                description: "Stays close to light, transit and police anchors while dodging reported crime clusters.",
            },
            {
                id: "scenic",
                label: "Scenic",
                description: "Seeks river walks, parks and tree-lined alleys for the most pleasant detour.",
            },
        ];
        const MODE_OPTIONS_BIKE = [
            {
                id: "fast",
                label: "Bike Direct",
                description: "Stay quick on cycle lanes and bikeable streets.",
            },
            {
                id: "safe",
                label: "Ride Safe",
                description: "Avoid crash hotspots and heavy traffic for a calmer ride.",
            },
            {
                id: "scenic",
                label: "Bike Scenic",
                description: "Thread through green corridors on bike-friendly paths.",
            },
        ];
        const MODE_COLORS = {
            fast: "#6b7280",   // greyish
            safe: "#0b4b7c",   // dark bluish
            scenic: "#0f6d2c", // green
        };
        const COMPARISON_METRICS = [
            { key: "green_share", upLabel: "more greenery", downLabel: "less greenery", betterWhen: "up" },
            { key: "safe_anchor_share", upLabel: "closer to help", downLabel: "fewer safe anchors", betterWhen: "up" },
            { key: "lit_share", upLabel: "better lighting", downLabel: "less lighting", betterWhen: "up" },
            { key: "bike_share", upLabel: "more bike infra", downLabel: "less bike infra", betterWhen: "up" },
            { key: "crime_hot_share", upLabel: "more hotspots", downLabel: "fewer hotspots", betterWhen: "down" },
            { key: "duration_s", upLabel: "longer trip", downLabel: "quicker trip", betterWhen: "down" },
        ];
        let map = L.map("map").setView([48.1374, 11.5755], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
        }).addTo(map);

        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;
        let currentMode = "safe";
        let currentTransport = "walk";
        let currentModeOptions = MODE_OPTIONS_WALK;
        const modeButtonsContainer = document.getElementById("mode-buttons");
        const transportToggle = document.getElementById("transport-toggle");
        const statDistance = document.getElementById("stat-distance");
        const statDuration = document.getElementById("stat-duration");
        const statSteps = document.getElementById("stat-steps");
        const statKcal = document.getElementById("stat-kcal");
        const statCo2 = document.getElementById("stat-co2");
        const statCo2Eq = document.getElementById("stat-co2-eq");
        const statStepsLabel = document.getElementById("stat-steps-label");
        const comparisonList = document.getElementById("comparison-list");
        resetStats();
        renderModeButtons();
        updateModeButtons();
        updateTransportUI();
        updateStatLabels();

        transportToggle.querySelectorAll("button").forEach(btn => {
            btn.addEventListener("click", () => {
                const target = btn.dataset.transport;
                if (target && target !== currentTransport) {
                    setTransport(target);
                }
            });
        });

        function renderModeButtons() {
            modeButtonsContainer.innerHTML = "";
            currentModeOptions.forEach(opt => {
                const card = document.createElement("div");
                card.className = "mode-card";
                card.dataset.mode = opt.id;

                const chip = document.createElement("button");
                chip.type = "button";
                chip.className = "mode-chip";
                chip.textContent = opt.label;
                chip.addEventListener("click", (event) => {
                    event.stopPropagation();
                    setMode(opt.id);
                });

                const desc = document.createElement("p");
                desc.textContent = opt.description;

                card.appendChild(chip);
                card.appendChild(desc);
                card.addEventListener("click", () => setMode(opt.id));
                modeButtonsContainer.appendChild(card);
            });
        }

        function setMode(mode) {
            currentMode = mode;
            updateModeButtons();
            if (startMarker && endMarker) {
                fetchRoute();
            }
        }

        function updateModeButtons() {
            document.querySelectorAll(".mode-card").forEach(card => {
                if (card.dataset.mode === currentMode) {
                    card.classList.add("active");
                } else {
                    card.classList.remove("active");
                }
            });
        }

        function setTransport(transport) {
            currentTransport = transport;
            currentModeOptions = transport === "bike" ? MODE_OPTIONS_BIKE : MODE_OPTIONS_WALK;
            renderModeButtons();
            updateModeButtons();
            updateTransportUI();
            updateStatLabels();
            resetStats();
            if (startMarker && endMarker) {
                fetchRoute();
            }
        }

        function updateTransportUI() {
            const isBike = currentTransport === "bike";
            document.body.classList.toggle("bike-mode", isBike);
            document.body.classList.toggle("walk-mode", !isBike);
            transportToggle.classList.toggle("bike", isBike);
            transportToggle.classList.toggle("walk", !isBike);
        }

        function updateStatLabels() {
            if (currentTransport === "bike") {
                statStepsLabel.textContent = "Calories";
                statSteps.textContent = "--";
                statKcal.textContent = "≈ -- Wh effort";
            } else {
                statStepsLabel.textContent = "Steps";
                statSteps.textContent = "--";
                statKcal.textContent = "≈ -- kcal burned";
            }
        }

        map.on("click", (e) => {
            if (!startMarker) {
                startMarker = L.marker(e.latlng).addTo(map).bindPopup("Start").openPopup();
            } else if (!endMarker) {
                endMarker = L.marker(e.latlng).addTo(map).bindPopup("End").openPopup();
                fetchRoute();
            } else {
                map.removeLayer(startMarker);
                map.removeLayer(endMarker);
                if (routeLayer) map.removeLayer(routeLayer);
                startMarker = L.marker(e.latlng).addTo(map).bindPopup("Start").openPopup();
                endMarker = null;
                resetStats();
            }
        });

        async function fetchRoute() {
            const start = startMarker.getLatLng();
            const end = endMarker.getLatLng();

            const url = `${backendUrl}/route?mode=${currentMode}&transport=${currentTransport}` +
                `&start_lat=${start.lat}&start_lon=${start.lng}` +
                `&end_lat=${end.lat}&end_lon=${end.lng}`;

            try {
                const res = await fetch(url);
                if (!res.ok) {
                    alert("No route found");
                    resetStats();
                    return;
                }
                const geojson = await res.json();
                drawRoute(geojson);
            } catch (e) {
                console.error(e);
                alert("Error fetching route");
                resetStats();
            }
        }

        function drawRoute(feature) {
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            const color = MODE_COLORS[currentMode] || "#228b22";
            routeLayer = L.geoJSON(feature, {
                style: {
                    color,
                    weight: 5
                }
            }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
            updateStats(feature.properties);
        }

        function updateStats(props) {
            if (!props || !props.stats) {
                resetStats();
                return;
            }
            const stats = props.stats;
            const lengthValue = stats.length_m ?? props.length_m ?? 0;
            const durationValue = stats.duration_s ?? props.duration_s ?? 0;
            const derived = computeDerivedImpacts(lengthValue);
            statDistance.textContent = formatDistance(lengthValue);
            statDuration.textContent = formatDuration(durationValue);
            if (currentTransport === "bike") {
                statSteps.textContent = formatCaloriesValue(derived.bikeKcal);
                statKcal.textContent = formatWh(derived.bikeWh);
            } else {
                statSteps.textContent = formatSteps(derived.steps);
                statKcal.textContent = formatCalories(derived.kcal);
            }
            statCo2.textContent = formatCo2(derived.savedCo2Kg);
            statCo2Eq.textContent = formatTangibleEquivalent(derived.savedCo2Kg);
            renderComparison(props.comparison_to_fast, props.comparison_custom);
        }

        function renderComparison(info, customData) {
            const custom = customData && Array.isArray(customData.statements) ? customData : null;
            comparisonList.innerHTML = "";
            if (custom && Array.isArray(custom.statements) && custom.statements.length) {
                custom.statements.forEach(item => {
                    const pill = document.createElement("span");
                    pill.className = `comparison-pill ${item.tone || "neutral"}`;
                    pill.textContent = item.text;
                    comparisonList.appendChild(pill);
                });
                return;
            }

            if (!info || !info.ratios) {
                comparisonList.innerHTML = '<span class="comparison-pill neutral">Run a route to compare with Direct</span>';
                return;
            }
            const baselineLabel = info.baseline_label || "Direct";
            const ratios = info.ratios;
            const statements = [];
            COMPARISON_METRICS.forEach(def => {
                const value = ratios[def.key];
                if (typeof value !== "number" || !Number.isFinite(value) || value === 0) {
                    return;
                }
                const deltaPct = Math.round(value * 100);
                if (!deltaPct) {
                    return;
                }
                const isPositive = deltaPct > 0;
                const label = isPositive ? def.upLabel : def.downLabel;
                const tone = ((isPositive && def.betterWhen === "up") || (!isPositive && def.betterWhen === "down")) ? "good" : "bad";
                const formatted = `${deltaPct > 0 ? "+" : ""}${deltaPct}% ${label} vs ${baselineLabel}`;
                statements.push({ text: formatted, tone });
            });

            if (!statements.length) {
                comparisonList.innerHTML = `<span class="comparison-pill neutral">No major differences vs ${baselineLabel}</span>`;
                return;
            }

            statements.slice(0, 3).forEach(item => {
                const pill = document.createElement("span");
                pill.className = `comparison-pill ${item.tone}`;
                pill.textContent = item.text;
                comparisonList.appendChild(pill);
            });
        }

        function formatDistance(meters) {
            if (!meters) return "0 m";
            if (meters >= 1000) {
                return `${(meters / 1000).toFixed(2)} km`;
            }
            return `${meters.toFixed(0)} m`;
        }

        function formatDuration(seconds) {
            if (!seconds || seconds < 60) {
                return "<1 min";
            }
            const minutes = Math.round(seconds / 60);
            if (minutes >= 60) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return mins ? `${hours} h ${mins} min` : `${hours} h`;
            }
            return `${minutes} min`;
        }

        function formatSteps(steps) {
            if (!steps) return "0";
            return Math.round(steps).toLocaleString("en-US");
        }

        function formatCaloriesValue(kcal) {
            if (!kcal) return "0";
            return Math.round(kcal).toLocaleString("en-US");
        }

        function formatWh(wh) {
            if (!wh) return "≈ 0 Wh";
            if (wh < 1) return "≈ <1 Wh";
            return `≈ ${Math.round(wh).toLocaleString("en-US")} Wh`;
        }

        function formatCalories(kcal) {
            if (!kcal || kcal < 1) return "≈ <1 kcal burned";
            return `≈ ${Math.round(kcal).toLocaleString("en-US")} kcal burned`;
        }

        function formatCo2(kg) {
            if (!kg) return "0 g";
            if (kg < 0.1) {
                const grams = kg * 1000;
                return `${Math.round(grams)} g`;
            }
            if (kg < 10) {
                return `${kg.toFixed(2)} kg`;
            }
            return `${kg.toFixed(1)} kg`;
        }

        function formatTangibleEquivalent(kg) {
            if (!kg) return "≈ 0 phones charged";
            const charges = Number(kg) / PHONE_CHARGE_CO2_KG;
            const rounded = Math.max(1, Math.round(charges));
            const integerValue = Math.trunc(rounded);
            const label = integerValue === 1 ? "phone charged" : "phones charged";
            return `≈ ${integerValue.toLocaleString("en-US")} ${label}`;
        }

        function computeDerivedImpacts(lengthMeters) {
            const distanceKm = (lengthMeters || 0) / 1000;
            const savedCo2Kg = distanceKm * CAR_CO2_KG_PER_KM;
            if (currentTransport === "bike") {
                const bikeKcal = distanceKm * BIKE_KCAL_PER_KM;
                const bikeWh = distanceKm * BIKE_WH_PER_KM;
                return { bikeKcal, bikeWh, savedCo2Kg };
            }
            const steps = lengthMeters > 0 ? lengthMeters / STEP_LENGTH_M : 0;
            const kcal = steps * KCAL_PER_STEP;
            return { steps, kcal, savedCo2Kg };
        }

        function resetStats() {
            statDistance.textContent = "--";
            statDuration.textContent = "--";
            statSteps.textContent = "--";
            statKcal.textContent = currentTransport === "bike" ? "≈ -- Wh effort" : "≈ -- kcal burned";
            statCo2.textContent = "--";
            statCo2Eq.textContent = "≈ tangible savings";
            comparisonList.innerHTML = '<span class="comparison-pill neutral">Pick two points to compare modes</span>';
        }
    </script>
</body>

</html>